# –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ (–ø–æ—Ä—Ç—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—à–∞–µ—Ç Traefik)
entryPoints:
  web:
    address: ":80"
  websecure:
    address: ":443"

# –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–æ—Ç–∫—É–¥–∞ Traefik —á–∏—Ç–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
providers:
  docker:
    exposedByDefault: false # –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —è–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  file:
    filename: /etc/traefik/traefik.yml # –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –∫–∞–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π
    watch: true # –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏

# Let's Encrypt (ACME) –¥–ª—è HTTPS –Ω–∞ VPS (–Ω—É–∂–µ–Ω SSL_EMAIL –≤ .env)
certificatesResolvers:
  letsencrypt:
    acme:
      email: "${SSL_EMAIL}"
      storage: /etc/letsencrypt/acme.json
      httpChallenge:
        entryPoint: web

# –õ–æ–≥–∏ Traefik
log:
  level: INFO

# –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–∞ (–∑–∞–ø—Ä–æ—Å—ã)
accessLog: {}

# –ü–∞–Ω–µ–ª—å Traefik. –í–∫–ª—é—á–µ–Ω–∞, –Ω–æ –ù–ï –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é (–ø—Ä–æ–∫—Å–∏—Ä—É–µ–º –Ω–∏–∂–µ –∫–∞–∫ service api@internal)
api:
  dashboard: true

# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Ä–æ—É—Ç–µ—Ä—ã/—Å–µ—Ä–≤–∏—Å—ã) ‚Äî –ø—Ä–æ–∫—Å–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ backend
http:
  routers:
    # üî¥ –í–ê–ñ–ù–û: –≠—Ç–æ—Ç —Ä–æ—É—Ç–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–ï–†–í–´–ú! üî¥
    # Let's Encrypt ACME Challenge (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞)
    acme-challenge:
      entryPoints: [web]
      rule: PathPrefix(`/.well-known/acme-challenge/`)
      service: noop@internal  # —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è Traefik
      priority: 1000  # –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

    # Dashboard –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (HTTP)
    traefik-dashboard:
      entryPoints: [web]
      rule: PathPrefix(`/dashboard`)
      middlewares: [traefik-auth]
      service: api@internal

    # Dashboard –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (HTTPS)
    traefik-websecure:
      entryPoints: [websecure]
      rule: PathPrefix(`/dashboard`)
      tls:
        certResolver: letsencrypt
      middlewares: [traefik-auth]
      service: api@internal

    backend-web:
      entryPoints: [web] # HTTP (–ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
      rule: PathPrefix(`/api`)
      service: we-meet-backend

    backend-websecure:
      entryPoints: [websecure] # HTTPS (VPS)
      rule: PathPrefix(`/api`)
      tls:
        certResolver: letsencrypt
      service: we-meet-backend

  services:
    we-meet-backend:
      loadBalancer:
        servers:
          - url: http://we-meet-backend:3000
        passHostHeader: true

  middlewares:
    traefik-auth:
      basicAuth:
        usersFile: /etc/traefik/usersfile